<div class="entity-picker @this.CssClass">
    <MudDrawer Color="Color.Dark" Open="@this.Open" Width="@this.Width" Class="mx-2" Elevation="3" Variant="DrawerVariant.Temporary" Anchor="Anchor.Right" OpenChanged="this.OnOpenChangedAsync" >

        @if (this.HeaderContent != null)
        {
            <div class="picker-header">
                @this.HeaderContent
            </div>
        }

        @if (this.ShowDefaultFilter)
        {
            <MudTextField Class="picker-filter-field mx-2" T="string" Value="this.DefaultFilterValue" Variant="Variant.Outlined" Margin="Margin.Dense" 
                AdornmentIcon="@this.FilterFieldIcon" Adornment="Adornment.Start" Clearable="true"
                Label="Filter" HelperText="@this.DefaultFilterHelperText" HelperTextOnFocus="true"
                DebounceInterval="200" MaxLength="128" ValueChanged="this.OnFilterTextChanged" />
        }

        <div class="picker-items" style="padding-bottom: @this.ItemsMargin;">
            @this.ChildContent
        </div>

        @if (this.ShowPrivacyAlert && !this._alertSuppressed)
        {
            <MudAlert Severity="Severity.Normal" Variant="Variant.Text" Class="picker-privacy-alert" ShowCloseIcon="true" CloseIconClicked="this.OnPolicyAlertClosed">
                For privacy reasons, only guilds both you and @EinherjiInfo.Name are in can be viewed.
            </MudAlert>
        }
    </MudDrawer>
</div>

@code {
    [Parameter]
    public bool Open { get; set; }
    [Parameter]
    public string CssClass { get; set; }
    [Parameter, EditorRequired]
    public RenderFragment ChildContent { get; set; }
    [Parameter]
    public string Width { get; set; } = "320px";

    [Parameter]
    public RenderFragment HeaderContent { get; set; }

    [Parameter]
    public bool ShowDefaultFilter { get; set; } = true;
    [Parameter]
    public string DefaultFilterValue { get; set; }
    [Parameter]
    public string DefaultFilterHelperText { get; set; } = "Find by Name";
    [Parameter]
    public EventCallback<string> DefaultFilterValueChanged { get; set; }

    [Parameter]
    public bool EnablePrivacyAlert { get; set; }

    [Parameter]
    public EventCallback<bool> OpenChanged { get; set; }

    private bool _alertSuppressed;

    private string FilterFieldIcon => string.IsNullOrWhiteSpace(this.DefaultFilterValue) ? Icons.Filled.FilterAltOff : Icons.Filled.FilterAlt;
    private bool ShowPrivacyAlert => this.EnablePrivacyAlert && !this._alertSuppressed && this.AuthProvider.User?.IsAdmin() != true;
    private string ItemsMargin => this.ShowPrivacyAlert && !this._alertSuppressed ? "70px" : "0";

    private Task OnOpenChangedAsync(bool open)
        => this.OpenChanged.InvokeAsync(open);

    private Task OnFilterTextChanged(string value)
        => this.DefaultFilterValueChanged.InvokeAsync(value);

    private void OnPolicyAlertClosed()
        => this._alertSuppressed = true;
}
