@page "/login/oauth"
@layout TehGM.EinherjiBot.UI.Layouts.EmptyLayout
@using TehGM.EinherjiBot.Security.API
@using TehGM.EinherjiBot.UI.Security
@inject IAuthService AuthService
@inject IDiscordLoginRedirect LoginRedirect
@inject NavigationManager Navigation

<PageTitle>Logging you in...</PageTitle>

<article class="d-flex justify-center align-center text-center page" style="width: 100%; min-height: 100vh;">
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Style="width: 15rem; height: 15rem;" />
</article>

@code {
    [Parameter, SupplyParameterFromQuery(Name = "state")]
    public string State { get; init; }
    [Parameter, SupplyParameterFromQuery(Name = "code")]
    public string AccessCode { get; init; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;
        try
        {
            LoginResponse response = await this.AuthService.LoginAsync(this.AccessCode).ConfigureAwait(false);
            if (!await this.LoginRedirect.ValidateStateAsync(this.State).ConfigureAwait(false))
                return;
            await (this.AuthProvider as IWebAuthProvider).LoginAsync(response).ConfigureAwait(false);
            this.Navigation.NavigateTo(OAuthState.Parse(this.State).ReturnURL, false, true);

        }
        catch { }
    }
}
